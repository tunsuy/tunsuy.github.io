## Rabbitmq访问控制

可以授予不同用户仅对特定虚拟主机的访问权限。它们在每个虚拟主机中的权限也可以受到限制。

RabbitMQ支持两种主要的身份验证机制以及多个身份验证和授权后端。认证和授权经常被混淆或互换使用。但是在RabbitMQ中，两者是分开的。
客户端使用RabbitMQ功能进行连接。每个连接都有一个经过身份验证的关联用户。它还针对用户必须具有一组特定权限的虚拟主机。
在连接启动时指定用户凭据，目标虚拟主机和（可选）客户端证书。

rabbitmq有一对默认的凭据，称为默认用户。默认情况下，此用户只能用于主机本地连接。使用它的远程连接将被拒绝。
生产环境不应使用默认用户，而应使用生成的凭据创建新的用户帐户。

服务器首次开始运行时，如果检测到其数据库尚未初始化或已被删除，它将使用以下资源初始化一个新的数据库：
* 一个名为/（斜线）的虚拟主机
* 一个名为guest的用户，其默认密码为guest，被授予对/虚拟主机的完全访问权限

在应用程序连接到RabbitMQ之后，在它可以执行操作之前，它必须进行身份验证，即显示并证明其身份。使用该身份，RabbitMQ节点可以查找其权限并授权对资源的访问，例如虚拟主机，队列，交换等。

验证客户端的两种主要方法是用"户名/密码对"和"X.509证书"。用户名/密码对可与各种验证凭据的身份验证后端一起使用

要使用X.509证书对客户端连接进行身份验证，必须启用内置插件`Rabbitmq-auth-mechanism-ssl`，并且必须将客户端配置为使用`EXTERNAL`机制。使用此机制，将忽略任何客户端提供的密码。

RabbitMQ客户端建立与服务器的连接并进行身份验证时，将指定要在其中运行的虚拟主机。此时，将执行第一级访问控制，服务器将检查用户是否具有访问虚拟主机的任何权限，否则拒绝连接尝试。
资源，即交换机和队列，是特定虚拟主机内的命名实体；即使是相同的名称在不同的虚拟主机中也表示不同的资源。当对资源执行某些操作时，将执行第二级访问控制。

RabbitMQ区分对资源的`配置，写入和读取`操作。
* 配置操作将创建或销毁资源，或更改其行为。
* 写操作将消息注入资源。
* 读取操作从资源中检索消息

RabbitMQ可能会基于每个连接或每个通道缓存访问控制检查的结果。因此，对用户权限的更改仅在用户重新连接时才生效。

RabbitMQ支持多种SASL身份验证机制。服务器中内置了三种此类机制：`PLAIN`，`AMQPLAIN`和`RABBIT-CR-DEMO`，其中一种（即`EXTERNAL`）可作为插件使用。
* PLAIN: 在RabbitMQ服务器和客户端中默认启用此功能，
* AMQPLAIN: 保留了PLAIN的非标准版本，以便向后兼容。默认情况下，在RabbitMQ服务器中启用此功能。
* EXTERNAL：使用带外机制（例如x509证书对等方验证，客户端IP地址范围等）进行验证。这种机制通常由RabbitMQ插件提供。
* RABBIT-CR-DEMO：演示质询响应身份验证的非标准机制。该机制具有与PLAIN等效的安全性，并且默认情况下在RabbitMQ服务器中未启用。

Rabbit应用程序中的配置变量auth_mechanisms确定将哪些已安装的机制提供给连接客户端。此变量应该是与机制名称相对应的原子列表，例如默认为`['PLAIN'，'AMQPLAIN']`。列表顺序无关
应用程序必须选择使用其他身份验证机制，例如EXTERNAL。

`rabbitmqctl authenticate_user`可用于测试用户名和密码对的身份验证
```sh
rabbitmqctl authenticate_user "a-username" "a/password"
```